<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>관광지 상세 보기</title>
    <script type="text/javascript"
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=8b23243ecce1d67f7d49784724586afa&libraries=services"></script>
    <style>
        #image-gallery {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 10px;
        }
        #image-gallery img {
            width: 200px;
            height: 150px;
            object-fit: cover;
            margin: 5px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>

<h1>관광지 상세 정보</h1>
<div id="map" style="width:100%; height:300px; border:1px solid #000; margin-bottom: 10px;"></div>

<dl>
    <dt><strong>관광지명</strong></dt>
    <dd id="spot-title">...로딩 중</dd>
    <dt><strong>지역</strong></dt>
    <dd id="spot-district">...</dd>
    <dt><strong>주소</strong></dt>
    <dd id="spot-address">...</dd>
    <dt><strong>전화번호</strong></dt>
    <dd id="spot-phone">...</dd>
    <dt><strong>상세설명</strong></dt>
    <dd id="spot-description" style="white-space: pre-wrap;">...</dd>
</dl>

<div id="image-gallery">
    <h3>관광 이미지</h3>
    <p id="image-loading-status">...이미지 로딩 중</p>
</div>


<script th:inline="javascript">
    /*<![CDATA[*/

    const touristId = /*[[${touristId}]]*/ 0;

    /*]]>*/

    let map;
    let geocoder;

    document.addEventListener("DOMContentLoaded", function() {
        const mapContainer = document.getElementById('map');
        const mapOption = {
            center: new kakao.maps.LatLng(37.566826, 126.9786567),
            level: 5
        };

        map = new kakao.maps.Map(mapContainer, mapOption);
        geocoder = new kakao.maps.services.Geocoder();

        if (touristId && touristId !== 0) {
            fetchDetails(touristId);
        }
    });

    function fetchDetails(id) {
        fetch(`/api/v1/tourist-spots/${id}`)
            .then(response => response.json())
            .then(data => {
                const spot = data.data;

                if (spot) {
                    document.getElementById('spot-title').textContent = spot.title;
                    document.getElementById('spot-district').textContent = spot.district;
                    document.getElementById('spot-address').textContent = spot.address;
                    document.getElementById('spot-phone').textContent = spot.phone;
                    document.getElementById('spot-description').textContent = spot.description;

                    if (spot.address) {
                        geocoder.addressSearch(spot.address, function(result, status) {
                            if (status === kakao.maps.services.Status.OK) {
                                const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                                map.setCenter(coords);
                                new kakao.maps.Marker({
                                    map: map,
                                    position: coords
                                });
                            }
                        });
                    }

                    fetchImages(spot.title);
                    // fetchImages(spot.district);

                } else {
                    document.getElementById('spot-title').textContent = "관광지 정보를 찾을 수 없습니다.";
                    document.getElementById('image-loading-status').textContent = "";
                }
            })
            .catch(error => {
                console.error('Error fetching details:', error);
                document.getElementById('spot-title').textContent = "오류가 발생했습니다.";
                document.getElementById('image-loading-status').textContent = "";
            });
    }
    // touristDetail.html의 fetchImages 함수

    function fetchImages(keyword) {
        const galleryContainer = document.getElementById('image-gallery');
        const statusText = document.getElementById('image-loading-status');

        const url = `/api/v1/tourist-spots/images?keyword=${encodeURIComponent(keyword)}`;

        fetch(url)
            .then(response => response.json()) // 1. .text()에서 .json()으로 변경
            .then(data => {
                // 2. JSON 구조(response.body.items.item)에 접근
                const items = data.response?.body?.items?.item;

                if (items && items.length > 0) {
                    statusText.style.display = 'none';

                    items.forEach(item => {
                        // 3. XML 파싱 로직 제거, 바로 객체 속성 접근
                        const imageUrl = item.galWebImageUrl;

                        if (imageUrl) {
                            const img = document.createElement('img');
                            img.src = imageUrl;
                            img.alt = item.galTitle;
                            img.referrerPolicy = "no-referrer";
                            galleryContainer.appendChild(img);
                        }
                    });
                } else {
                    statusText.textContent = "관련 이미지를 찾을 수 없습니다.";
                }
            })
            .catch(error => {
                console.error('Error fetching images:', error);
                statusText.textContent = "이미지 로딩 중 오류가 발생했습니다.";
            });
    }
</script>

</body>
</html>