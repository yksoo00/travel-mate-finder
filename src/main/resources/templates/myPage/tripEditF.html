/ ==================== ë§ˆì´í˜ì´ì§€ JavaScript ====================
// ==================== Left Container Loader ====================
const token = localStorage.getItem('accessToken');

async function loadLeftView(type) {
const url = type === "edit"
? "/profile-edit"     // âœ” ì˜³ì€ URL
: "/profile-view";    // âœ” ì˜³ì€ URL

const res = await fetch(url);
const html = await res.text();

const leftContainer = document.getElementById("leftContainer");
leftContainer.innerHTML = html;

// HTMLì´ ì‚½ì…ëœ ë’¤ ì‹¤í–‰
if (type === "view") {
setTimeout(loadProfileView, 0);
} else {
setTimeout(loadProfileEdit, 0);
}
}

// ğŸ”¥ ì—¬ê¸°ì— ì¶”ê°€
function goEdit() {
loadLeftView("edit");
}

// ì „ì—­ fetch ì˜¤ë²„ë¼ì´ë“œ (ëª¨ë“  ìš”ì²­ì— ìë™ìœ¼ë¡œ Authorization ì¶”ê°€)
// ì „ì—­ fetch ì˜¤ë²„ë¼ì´ë“œ
const _originalFetch = window.fetch;
window.fetch = async (url, options = {}) => {
const headers = options.headers ? {...options.headers} : {};

// Authorization ìë™ ì¶”ê°€
headers["Authorization"] = Bearer ${token};

// â— FormDataê°€ ì•„ë‹ ë•Œë§Œ Content-Type ì„¤ì •
const isFormData = options.body instanceof FormData;
if (!isFormData) {
headers["Content-Type"] = "application/json";
}

return _originalFetch(url, {
...options,
headers
});
};

// ================================================================

let allTrips = [];

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener("DOMContentLoaded", async () => {
const urlParams = new URLSearchParams(window.location.search);

// ì—¬ê¸°ì„œ í™•ì •ì ìœ¼ë¡œ ì´ˆê¸°í™”

await loadLeftView("view");
loadTripCard();
loadTrips();
});

// í”„ë¡œí•„ ì •ë³´
async function loadProfileView() {
const res = await fetch(/api/v1/myPage, {
headers: {
'Accept': 'application/json',
'Authorization': Bearer ${token}
}
});
const data = await res.json();

if (data.status !== 200) {
return;
}

const p = data.data;

let img = p.profileImage;

if (!img || img.trim() === "" || img === "null") {
img = "/images/default-profile.png";
}
document.getElementById("profileImageView").src = img;
document.getElementById("profileImageView").src = img;
document.getElementById("nickNameView").textContent = p.nickName;
document.getElementById("ageView").textContent = p.age + "ì„¸";
document.getElementById("genderView").textContent = p.gender === "M" ? "ë‚¨ì„±"
: "ì—¬ì„±";
document.getElementById("emailView").textContent = p.email;
document.getElementById("introView").textContent = p.introduction
?? "ìê¸°ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.";
}

async function loadProfileEdit() {
const res = await fetch(/api/v1/myPage}, {
headers: {
'Accept': 'application/json',
'Authorization': Bearer ${token}
}
});
const data = await res.json();

const p = data.data;

currentImageUrl = p.profileImage ?? "/images/default-profile.png";
document.getElementById("profileImagePreview").src = currentImageUrl;

document.getElementById("nickNameInput").value = p.nickName;
document.getElementById("emailInput").value = p.email;
document.getElementById("introInput").value = p.introduction ?? "";
}

// í”„ë¡œí•„ í‘œì‹œ
function displayProfile(profile) {
let imageUrl = profile.profileImage;

if (!imageUrl || imageUrl === "null" || imageUrl.trim() === "") {
imageUrl = "https://ui-avatars.com/api/?name=User&background=E0E0E0&color=555&size=200";
}

document.getElementById("profileImage").src = imageUrl;
document.getElementById('profileImage').src = profile.profileImage
|| '/images/default-profile.png';
document.getElementById('nickName').textContent = profile.nickName
|| 'ë‹‰ë„¤ì„ ì—†ìŒ';
document.getElementById('age').textContent = profile.age ? ${profile.age}ì„¸
: 'ë‚˜ì´ ë¯¸ê³µê°œ';
const genderText = profile.gender === 'M' ? 'ë‚¨ì„±' : profile.gender === 'F'
? 'ì—¬ì„±' : 'ì„±ë³„ ë¯¸ê³µê°œ';
document.getElementById('gender').textContent = genderText;
document.getElementById('email').textContent = profile.email || 'ì´ë©”ì¼ ì—†ìŒ';
document.getElementById('introduction').textContent = profile.introduction
|| 'ìê¸°ì†Œê°œê°€ ì—†ìŠµë‹ˆë‹¤.';
}

// ì—¬í–‰ ì¹´ë“œ í†µê³„ ë¡œë“œ
async function loadTripCard() {
try {
const response = await fetch(
/api/v1/myPage/card, {
headers: {
'Accept': 'application/json',
'Authorization': Bearer ${token}
}
});
const data = await response.json();

if (data.status === 200) {
displayTripCard(data.data);
} else if (data.status === 404) {
displayEmptyCard();
}
} catch (error) {
console.error('ì¹´ë“œ ë¡œë“œ ì˜¤ë¥˜:', error);
displayEmptyCard();
}
}

// ì—¬í–‰ ì¹´ë“œ í‘œì‹œ
function displayTripCard(cardData) {
document.getElementById('dstcCnt').textContent = cardData.dstcCnt || 0;
document.getElementById('ttlCnt').textContent = cardData.ttlCnt || 0;
document.getElementById('dayCnt').textContent = cardData.dayCnt || 0;
}

// ë¹ˆ ì¹´ë“œ í‘œì‹œ
function displayEmptyCard() {
document.getElementById('dstcCnt').textContent = 0;
document.getElementById('ttlCnt').textContent = 0;
document.getElementById('dayCnt').textContent = 0;
}

// ì—¬í–‰ ì¼ì • ëª©ë¡ ë¡œë“œ
async function loadTrips() {
try {
const response = await fetch(
/api/v1/myPage/trips, {
method: 'GET',
headers: {
'Accept': 'application/json',
'Authorization': Bearer ${token}
}
});
const data = await response.json();

if (data.status === 200) {
allTrips = data.data;
displayTrips(allTrips);
} else {
displayEmptyTrips();
}
} catch (error) {
console.error('ì—¬í–‰ ì¼ì • ë¡œë“œ ì˜¤ë¥˜:', error);
displayEmptyTrips();
}
}

// ì—¬í–‰ ì¼ì • í‘œì‹œ
function displayTrips(trips) {
const tripList = document.getElementById('tripList');

if (!trips || trips.length === 0) {
displayEmptyTrips();
return;
}

tripList.innerHTML = trips.map(trip => {
// D-day ê³„ì‚°
const dDay = calculateDday(trip.startDate);

return
<div class="trip-card" onclick="event.stopPropagation()">
  <div class="trip-dday ${getDdayClass(dDay)}">${dDay}</div>
  <div class="trip-destination">${trip.destination}</div>
  <div class="trip-title">${trip.title}</div>
  <div class="trip-dates">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#888" stroke-width="2">
      <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
      <line x1="16" y1="2" x2="16" y2="6"></line>
      <line x1="8" y1="2" x2="8" y2="6"></line>
      <line x1="3" y1="10" x2="21" y2="10"></line>
    </svg>
    ${trip.startDate} ~ ${trip.endDate}
  </div>
  <div class="trip-info-row">
    <div class="trip-duration">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#666" stroke-width="2">
        <circle cx="12" cy="12" r="10"></circle>
        <polyline points="12 6 12 12 16 14"></polyline>
      </svg>
      ${trip.duration}ì¼
    </div>
    <div class="trip-budget">${formatBudget(trip.budget)}</div>
  </div>
  <div class="trip-actions">
    <button class="btn-edit" onclick="editTrip(${trip.id})">ìˆ˜ì •</button>
    <button class="btn-delete" onclick="deleteTrip(${trip.id})">ì‚­ì œ</button>
  </div>
</div>
;
}).join('');
}

async function uploadProfileImage() {
if (!selectedFile) {
return currentImageUrl;
}

const fd = new FormData();
fd.append("file", selectedFile);

const uploadRes = await fetch(
/api/v1/myPage/profile/image, {
method: "POST",
body: fd
});

const uploadData = await uploadRes.json();
return uploadData.data;
}

// ë¹ˆ ì—¬í–‰ ì¼ì • í‘œì‹œ
function displayEmptyTrips() {
const tripList = document.getElementById('tripList');
tripList.innerHTML =
<div class="empty-state">
  <div class="empty-icon">âœˆï¸</div>
  <div class="empty-text">ì•„ì§ ë“±ë¡ëœ ì—¬í–‰ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>
  <div class="empty-text" style="font-size: 14px; color: #aaa; margin-top: 8px;">
    ìœ„ì˜ "ì¼ì • ì¶”ê°€" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì²« ì—¬í–‰ì„ ë“±ë¡í•´ë³´ì„¸ìš”!
  </div>
</div>
;
}

// D-day í´ë˜ìŠ¤ ë°˜í™˜
function getDdayClass(dday) {
if (!dday || typeof dday !== 'string') {
return 'past'; // ê¸°ë³¸ê°’ (í˜¹ì€ 'unknown', 'none' ë“±ìœ¼ë¡œë„ ê°€ëŠ¥)
}

if (dday.startsWith('D-') && !dday.includes('+')) {
return 'upcoming';
} else if (dday === 'D-Day') {
return 'today';
} else {
return 'past';
}
}

// ì˜ˆì‚° í¬ë§·
function formatBudget(budget) {
if (!budget) {
return 'ì˜ˆì‚° ë¯¸ì •';
}
return budget.toLocaleString() + 'ì›';
}

// ì—¬í–‰ ì‚­ì œ
async function deleteTrip(tripId) {
if (!confirm('ì •ë§ ì´ ì—¬í–‰ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
return;
}

try {
const response = await fetch(/api/v1/myPage/trips/${tripId},
{method: 'DELETE'});
const data = await response.json();

if (data.status === 200) {
alert('ì—¬í–‰ ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
loadTrips();
loadTripCard();
} else {
alert(ì‚­ì œ ì‹¤íŒ¨: ${data.message});
}
} catch (error) {
console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
}
}

// ì—ëŸ¬ í‘œì‹œ
function showError(message) {
alert(message);
}

function calculateDday(startDate) {
if (!startDate) {
return 'D-?';
}

const today = new Date();
const start = new Date(startDate);
const diffTime = start - today;
const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

if (diffDays > 0) {
return D-${diffDays};
}
if (diffDays === 0) {
return 'D-Day';
}
return D+${Math.abs(diffDays)};
}

window.goEdit = function () {
loadLeftView("edit");
};

window.cancelEdit = function () {
loadLeftView("view");
};

async function submitProfileEdit() {

// 1) ì´ë¯¸ì§€ ë¨¼ì € ì—…ë¡œë“œ (í•„ìš”í•  ë•Œë§Œ)
const finalImageUrl = await uploadProfileImage();

// 2) ë°±ì—”ë“œëŠ” @RequestBody JSONë§Œ ë°›ìŒ
const dto = {
nickName: document.getElementById("nickNameInput").value,
email: document.getElementById("emailInput").value,
introduction: document.getElementById("introInput").value,
profileImage: finalImageUrl
};

// 3) PUT JSON ìš”ì²­
const response = await fetch(/api/v1/myPage, {
method: "PUT",
headers: {
"Authorization": Bearer ${token},
"Content-Type": "application/json"
},
body: JSON.stringify(dto)
});

const data = await response.json();

if (data.status === 200) {
alert("í”„ë¡œí•„ ìˆ˜ì • ì™„ë£Œ!");
loadLeftView("view");   // ìˆ˜ì • í›„ ë‹¤ì‹œ í”„ë¡œí•„ ë³´ê¸° ë¡œë”©
} else {
alert("ìˆ˜ì • ì‹¤íŒ¨: " + data.message);
}
}

function previewImage(event) {
const file = event.target.files[0];
if (!file) {
return;
}

selectedFile = file;
const reader = new FileReader();
reader.onload = e => {
document.getElementById("profileImagePreview").src = e.target.result;
};
reader.readAsDataURL(file);
}

function createTrip() {
loadRightView(/myPage/trip/create);
}

async function editTrip(tripId) {
// 1) ë¦¬ìŠ¤íŠ¸ì—ì„œ trip ì°¾ê¸°
const trip = allTrips.find(t => t.id === tripId);
if (!trip) {
alert("ì—¬í–‰ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
return;
}

// 2) ì „ì—­ì— ë³´ê´€
window.currentEditingTrip = trip;

// 3) ì˜¤ë¥¸ìª½ì— ìˆ˜ì • í™”ë©´ fragment ë¡œë“œ
await loadRightView(/myPage/trip/edit/${tripId});

// 4) fragment ê°€ rightContainer ì•ˆì— ë¶™ì€ ë‹¤ìŒ í¼ ì±„ìš°ê¸°
//    (HTML íŒŒì‹± ì§í›„ ì‹¤í–‰ë˜ë„ë¡ 0ms)
setTimeout(fillTripEditForm, 0);
}

// ì˜¤ë¥¸ìª½ ì»¨í…ì¸  ë¡œë”
async function loadRightView(path) {
try {
const res = await fetch(path);
const html = await res.text();

const container = document.getElementById("rightContainer");
if (!container) {
console.error("#rightContainer ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
return;
}

container.innerHTML = html;

// â— ì—¬ê¸°ì„œëŠ” ì•„ë¬´ ê²ƒë„ í•˜ì§€ ì•ŠìŒ
// (fillTripEditForm í˜¸ì¶œì€ editTrip ì•ˆì—ì„œ ì²˜ë¦¬)
} catch (err) {
console.error("ì˜¤ë¥¸ìª½ í™”ë©´ ë¡œë“œ ì‹¤íŒ¨:", err);
}
}

function fillTripEditForm() {
const t = window.currentEditingTrip;
if (!t) {
return;
}

const dest = document.getElementById("destination");
if (!dest) {
console.warn("destination input not found yet");
return;
}

dest.value = t.destination;
document.getElementById("title").value = t.title;
document.getElementById("startDate").value = t.startDate;
document.getElementById("endDate").value = t.endDate;
document.getElementById("budget").value = t.budget ?? "";
document.getElementById("memo").value = t.memo ?? "";

const charCount = document.getElementById("charCount");
if (charCount) {
charCount.textContent = (t.memo?.length ?? 0);
}
}

async function submitTrip(event) {
event.preventDefault();

const tripData = {
destination: document.getElementById('destination').value,
title: document.getElementById('title').value,
startDate: document.getElementById('startDate').value,
endDate: document.getElementById('endDate').value,
budget: parseInt(document.getElementById('budget').value) || 0,
memo: document.getElementById('memo').value
};

const tripId = window.currentEditingTrip.id;

const response = await fetch(/api/v1/myPage/trips/${tripId}, {
method: "PUT",
headers: {
"Content-Type": "application/json",
"Authorization": Bearer ${token},
},
body: JSON.stringify(tripData),
});

const data = await response.json();

if (data.status === 200) {
alert("ìˆ˜ì • ì™„ë£Œ!");
window.location.href = '/myPage';

} else {
alert("ìˆ˜ì • ì‹¤íŒ¨: " + data.message);
}
}

function submitTripFromButton() {
const form = document.getElementById("tripCreateForm");
if (form.checkValidity()) {
submitTripCreate(new Event("submit"));
} else {
form.reportValidity();
}
}

async function submitTripCreate(event) {
event.preventDefault();

const tripData = {
destination: document.getElementById('destination').value,
title: document.getElementById('title').value,
startDate: document.getElementById('startDate').value,
endDate: document.getElementById('endDate').value,
budget: parseInt(document.getElementById('budget').value) || 0,
memo: document.getElementById('memo').value
};

const response = await fetch(
/api/v1/myPage/trips, {
method: "POST",
body: JSON.stringify(tripData)
});

const data = await response.json();

if (data.status === 200 || data.status === 201) {
alert("ì—¬í–‰ ì¼ì •ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
window.location.href = '/myPage';

} else {
alert("ë“±ë¡ ì‹¤íŒ¨: " + data.message);
}
}

function cancelCreate() {
loadRightView("/myPage/right/default");
}