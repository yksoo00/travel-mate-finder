<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>여행 일정 등록 - OUIGO</title>
    <link rel="stylesheet" th:href="@{/css/layout.css}">
    <link rel="stylesheet" th:href="@{/css/navbar.css}">
    <link rel="stylesheet" th:href="@{/css/mypage.css}">
</head>
<body>
<!-- Navbar -->
<div th:replace="~{navbar :: navbar}"></div>

<!-- Main Content -->
<div style="background-color: #f8f9fa; min-height: 100vh; padding: 40px 20px;">
    <div class="edit-container">
        <!-- Header with Buttons -->
        <div class="edit-header">
            <div class="edit-title">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#00BFFF" stroke-width="2">
                    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                    <circle cx="12" cy="10" r="3"></circle>
                </svg>
                여행 일정 등록
            </div>

            <!-- Header Button Group -->
            <div class="header-button-group">
                <button type="button" class="btn-header-cancel" onclick="cancelCreate()">
                    취소
                </button>
                <button type="button" class="btn-header-submit" onclick="submitTripFromButton()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="display: inline-block; vertical-align: middle; margin-right: 6px;">
                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                    </svg>
                    등록하기
                </button>
            </div>
        </div>

        <!-- Form -->
        <form id="tripCreateForm" onsubmit="submitTrip(event)">
            <!-- 여행 지역 -->
            <div class="form-group">
                <label class="form-label">
                    여행 지역 <span class="required">*</span>
                </label>
                <input type="text" id="destination" class="form-input" placeholder="예: 제주도, 부산, 강릉" required>
            </div>

            <!-- 여행 관광지 -->
            <div class="form-group">
                <label class="form-label">
                    여행 관광지 <span class="required">*</span>
                </label>
                <input type="text" id="title" class="form-input" placeholder="예: 성산일출봉, 해운대 해수욕장" required>
            </div>

            <!-- 날짜 -->
            <div class="date-group">
                <div class="form-group">
                    <label class="form-label">
                        시작일 <span class="required">*</span>
                    </label>
                    <input type="date" id="startDate" class="form-input" required onchange="validateDates()">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        종료일 <span class="required">*</span>
                    </label>
                    <input type="date" id="endDate" class="form-input" required onchange="validateDates()">
                </div>
            </div>

            <!-- 예산 -->
            <div class="form-group">
                <label class="form-label">
                    예산 (원)
                </label>
                <input type="number" id="budget" class="form-input" placeholder="예: 500000" min="0" step="10000">
                <div class="form-hint">숫자만 입력하세요 (선택사항)</div>
            </div>

            <!-- 메모 -->
            <div class="form-group">
                <label class="form-label">
                    여행 메모
                </label>
                <textarea id="memo" class="form-textarea" placeholder="여행 메모를 입력하세요 (최대 100자)" maxlength="100" oninput="updateCharCount()"></textarea>
                <div class="char-count">
                    <span id="charCount">0</span> / 100
                </div>
            </div>
        </form>
    </div>
</div>

<script th:inline="javascript">
    const token = "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJqb2huIiwiYXV0aCI6IlJPTEVfVVNFUiIsImV4cCI6MTc2MzAxMjA3OH0.9ZyMi_h2zZRbrpCryRBElhvXCRuaqI00S-ML7uYIqwU0JGmlPzjv9ksnyaH2O33sWXnLGlQeqAh8AAmPFvGoNg";
    /*<![CDATA[*/
    const memberNo = /*[[${memberNo}]]*/ 1;
    /*]]>*/

    // 날짜 유효성 검증
    function validateDates() {
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;

        if (startDate && endDate) {
            if (new Date(startDate) > new Date(endDate)) {
                alert('종료일은 시작일보다 이후여야 합니다.');
                document.getElementById('endDate').value = '';
            }
        }
    }

    // 글자 수 업데이트
    function updateCharCount() {
        const memo = document.getElementById('memo').value;
        document.getElementById('charCount').textContent = memo.length;
    }

    // 헤더 버튼에서 호출하는 함수
    function submitTripFromButton() {
        const form = document.getElementById('tripCreateForm');

        // HTML5 폼 검증 실행
        if (form.checkValidity()) {
            submitTrip(new Event('submit'));
        } else {
            // 검증 실패 시 첫 번째 에러 필드로 포커스
            form.reportValidity();
        }
    }

    // 여행 등록 제출 (백엔드 연결)
    async function submitTrip(event) {
        event.preventDefault();

        // 입력값 가져오기
        const destination = document.getElementById('destination').value.trim();
        const title = document.getElementById('title').value.trim();
        const startDate = document.getElementById('startDate').value;
        const endDate = document.getElementById('endDate').value;
        const budgetInput = document.getElementById('budget').value;
        const memo = document.getElementById('memo').value.trim();

        // 필수 입력 검증
        if (!destination) {
            alert('여행 지역을 입력해주세요.');
            document.getElementById('destination').focus();
            return;
        }

        if (!title) {
            alert('여행 관광지를 입력해주세요.');
            document.getElementById('title').focus();
            return;
        }

        if (!startDate) {
            alert('시작일을 선택해주세요.');
            document.getElementById('startDate').focus();
            return;
        }

        if (!endDate) {
            alert('종료일을 선택해주세요.');
            document.getElementById('endDate').focus();
            return;
        }

        // 날짜 재검증
        if (new Date(startDate) > new Date(endDate)) {
            alert('종료일은 시작일보다 이후여야 합니다.');
            return;
        }

        // TripReqDto 형식에 맞게 데이터 구성
        const tripData = {
            destination: destination,
            title: title,
            startDate: startDate,      // LocalDate 형식 (YYYY-MM-DD)
            endDate: endDate,          // LocalDate 형식 (YYYY-MM-DD)
            budget: budgetInput ? parseInt(budgetInput) : 0,
            memo: memo || null
        };


        try {
            // POST /api/v1/myPage/trips?memberNo={memberNo}
            const response = await fetch(`/api/v1/myPage/trips?memberNo=${memberNo}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(tripData)
            });

            const data = await response.json();
            console.log('서버 응답:', data);

            // 성공 시 마이페이지로 이동
            if (data.status === 201 || data.status === 200) {
                alert('여행 일정이 등록되었습니다!');
                window.location.href = `/myPage?memberNo=${memberNo}`;
            } else {
                alert(`등록 실패: ${data.message}`);
            }
        } catch (error) {
            console.error('여행 등록 오류:', error);
            alert('서버 오류가 발생했습니다. 다시 시도해주세요.');
        }
    }

    // 취소 버튼
    function cancelCreate() {
        if (confirm('작성 중인 내용이 사라집니다. 정말 취소하시겠습니까?')) {
            window.location.href = `/myPage?memberNo=${memberNo}`;
        }
    }
</script>
</body>
</html>
